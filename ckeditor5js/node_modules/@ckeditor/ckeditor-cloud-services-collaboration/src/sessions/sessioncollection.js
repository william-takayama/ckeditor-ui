/*
 *             Copyright (c) 2016 - 2022, CKSource Holding sp. z o.o. All rights reserved.
 *
 *
 *
 *
 *          +---------------------------------------------------------------------------------+
 *          |                                                                                 |
 *          |                                 Hello stranger!                                 |
 *          |                                                                                 |
 *          |                                                                                 |
 *          |   What you're currently looking at is the source code of a legally protected,   |
 *          |    proprietary software. Any attempts to deobfuscate / disassemble this code    |
 *          |               are forbidden and will result in legal consequences.              |
 *          |                                                                                 |
 *          |                                                                                 |
 *          +---------------------------------------------------------------------------------+
 *
 *
 *
 *
 */
'use strict';var __importDefault=this&&this['__importDefault']||function(_0x2efd9a){return _0x2efd9a&&_0x2efd9a['__esModule']?_0x2efd9a:{'default':_0x2efd9a};};Object['defineProperty'](exports,'__esModule',{'value':!0x0});const utils_1=require('ckeditor5/src/utils'),sessions_1=require('./sessions'),user_1=__importDefault(require('./../users/user')),websocketgateway_1=__importDefault(require('./../websocketgateway/websocketgateway')),sessionsconnectresponse_1=__importDefault(require('./responses/sessionsconnectresponse')),sessionsconnectmessage_1=__importDefault(require('./messages/sessionsconnectmessage')),socketconnectmessage_1=__importDefault(require('./messages/socketconnectmessage')),socketdisconnectmessage_1=__importDefault(require('./messages/socketdisconnectmessage')),messagescompressor_1=__importDefault(require('./../messagescompressor'));class SessionCollection extends utils_1['Collection']{constructor(_0x18de65,_0x36c23d){super({'idProperty':'id'}),this['_id']=_0x18de65,this['_sessionType']=_0x36c23d,this['_handlers']=new Map(),this['_eventsQueue']=[],this['_isRunning']=!0x1;}async['connect'](_0x189646){this['_wsGateway']=_0x189646,this['stopListening'](_0x189646,'change:state');const _0x3be9f0=new sessionsconnectmessage_1['default'](this['_id'],this['_sessionType']);let _0x299eb9;try{const _0x1f96f3=await this['_wsGateway']['_sendRequest'](sessions_1['_SERVICE'],sessionsconnectmessage_1['default']['TYPE'],messagescompressor_1['default']['encode'](_0x3be9f0));_0x299eb9=messagescompressor_1['default']['decode'](_0x1f96f3,sessionsconnectresponse_1['default']);}catch(_0x4139b7){_0x299eb9=new sessionsconnectresponse_1['default'](this['_id'],[]);}this['_connectToChannel'](this['_wsGateway'],_0x299eb9['channel'],this['_sessionType']);const _0xa3ec9a=await async function(_0x341ffb,_0x47958e){const _0x193459=_0x47958e['map'](_0x4952ee=>_0x4952ee['userId']),_0x42e4bf=_0x193459['length']?await user_1['default']['getMany'](_0x341ffb,_0x193459):[];return _0x47958e['map'](_0x51dfc8=>{const _0x378660={'id':_0x51dfc8['id'],'role':_0x51dfc8['role'],'permissions':_0x51dfc8['permissions']};return _0x378660['user']=_0x51dfc8['userId']&&_0x42e4bf['find'](_0x2075a4=>_0x2075a4['id']===_0x51dfc8['userId'])||new user_1['default'](),_0x378660;});}(this['_wsGateway'],_0x299eb9['sockets']);for(const _0x381463 of _0xa3ec9a)super['add'](_0x381463);this['_connected']=!0x0,this['fire']('connected'),this['listenTo'](this['_wsGateway'],'change:state',(_0x1ae75c,_0x5dde04,_0x4989fb)=>this['_onWsGatewayStateChange'](_0x4989fb),{'priority':websocketgateway_1['default']['_CHANGE_STATE_EVENT_PRIORITY']}),await this['_runQueue']();}['disconnect'](_0xf27c75=!0x0){if(this['_connected']){for(this['_connected']=!0x1,this['_eventsQueue']=[];this['length'];)super['remove'](0x0);this['_channel']&&(this['stopListening'](this['_channel']),this['_channel']=void 0x0),this['_wsGateway']&&_0xf27c75&&(this['stopListening'](this['_wsGateway']),this['_wsGateway']=void 0x0),this['fire']('disconnected'),_0xf27c75&&this['stopListening']();}}['add'](_0x1b4c53,_0xf1e46b){throw new TypeError('The\x20collection\x20is\x20read-only.');}['remove'](_0x4a407c){throw new TypeError('The\x20collection\x20is\x20read-only.');}['_connectToChannel'](_0x30cf29,_0x179dbe,_0x27e45f){this['_channel']=_0x30cf29['_getChannel'](_0x27e45f,_0x179dbe),this['_channel']&&(this['_addHandler'](this['_channel'],socketconnectmessage_1['default']['TYPE'],async _0x2905c0=>{const _0x4aaa75=messagescompressor_1['default']['decode'](_0x2905c0,socketconnectmessage_1['default']);if(-0x1===this['getIndex'](_0x4aaa75['id'])){const _0x409eb9={'id':_0x4aaa75['id'],'role':_0x4aaa75['role'],'permissions':_0x4aaa75['permissions']};_0x4aaa75['userId']&&(_0x409eb9['user']=await user_1['default']['get'](_0x30cf29,_0x4aaa75['userId'])),super['add'](_0x409eb9);}}),this['_addHandler'](this['_channel'],socketdisconnectmessage_1['default']['TYPE'],_0xbba1d7=>{const _0x18c1b3=messagescompressor_1['default']['decode'](_0xbba1d7,socketdisconnectmessage_1['default']);-0x1!==this['getIndex'](_0x18c1b3['id'])&&super['remove'](_0x18c1b3['id']);}));}async['_onWsGatewayStateChange'](_0x1f29fe){_0x1f29fe===websocketgateway_1['default']['STATE_DISCONNECTED']&&this['disconnect'](!0x1),_0x1f29fe===websocketgateway_1['default']['STATE_CONNECTED']&&await this['connect'](this['_wsGateway']);}async['_runQueue'](){if(this['_isRunning']||!this['_connected'])return;let _0x409482;for(this['_isRunning']=!0x0;_0x409482=this['_eventsQueue']['shift']();){const _0x450575=this['_handlers']['get'](_0x409482['eventName']);_0x450575&&await _0x450575(_0x409482['data']);}this['_isRunning']=!0x1;}['_addHandler'](_0x44e283,_0x59a76d,_0x35785d){const _0x8594ca=_0x44e283['getEventName'](_0x59a76d,!0x0);this['listenTo'](_0x44e283,_0x8594ca,async(_0x2aa8a3,_0x26f60a)=>{const _0x513dbb=_0x2aa8a3['name'];this['_eventsQueue']['push']({'eventName':_0x513dbb,'data':_0x26f60a}),await this['_runQueue']();}),this['_handlers']['set'](_0x8594ca,_0x35785d);}}exports['default']=SessionCollection;