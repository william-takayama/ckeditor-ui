/*
 *             Copyright (c) 2016 - 2022, CKSource Holding sp. z o.o. All rights reserved.
 *
 *
 *
 *
 *          +---------------------------------------------------------------------------------+
 *          |                                                                                 |
 *          |                                 Hello stranger!                                 |
 *          |                                                                                 |
 *          |                                                                                 |
 *          |   What you're currently looking at is the source code of a legally protected,   |
 *          |    proprietary software. Any attempts to deobfuscate / disassemble this code    |
 *          |               are forbidden and will result in legal consequences.              |
 *          |                                                                                 |
 *          |                                                                                 |
 *          +---------------------------------------------------------------------------------+
 *
 *
 *
 *
 */
'use strict';var __importDefault=this&&this['__importDefault']||function(_0x26c41d){return _0x26c41d&&_0x26c41d['__esModule']?_0x26c41d:{'default':_0x26c41d};};Object['defineProperty'](exports,'__esModule',{'value':!0x0}),exports['_SERVICE']=void 0x0;const uuid_1=require('uuid'),utils_1=require('ckeditor5/src/utils'),messagescompressor_1=__importDefault(require('./../messagescompressor')),sessions_1=__importDefault(require('./../sessions/sessions')),collaborativeeditingconnectmessage_1=__importDefault(require('./messages/collaborativeeditingconnectmessage')),collaborativeeditingupdatemessage_1=__importDefault(require('./messages/collaborativeeditingupdatemessage')),collaborativeeditingreconnectmessage_1=__importDefault(require('./messages/collaborativeeditingreconnectmessage')),collaborativeeditingresponse_1=__importDefault(require('./responses/collaborativeeditingresponse')),collaborativeeditingconnectresponse_1=__importDefault(require('./responses/collaborativeeditingconnectresponse')),websocketgateway_1=__importDefault(require('./../websocketgateway/websocketgateway')),ckeditorcloudserviceserror_1=__importDefault(require('../ckeditorcloudserviceserror')),ServiceNotConnectedError_1=__importDefault(require('../errors/ServiceNotConnectedError')),getdocumentdetailsresponse_1=__importDefault(require('./responses/getdocumentdetailsresponse')),getdocumentdetailsmessage_1=__importDefault(require('./messages/getdocumentdetailsmessage'));exports['_SERVICE']=0x1;class CollaborativeEditingService{constructor(_0x258959,_0x235351){if(!_0x258959)throw new TypeError('Param\x20\x22bundleVersion\x22\x20must\x20be\x20provided.');this['_id']=null!=_0x235351?_0x235351:(0x0,uuid_1['v4'])(),this['_isConnected']=!0x1,this['_bundleVersion']=_0x258959;}['getId'](){return this['_id'];}['isConnected'](){return this['_isConnected'];}['connect'](_0x387f25,_0x5e2120={'buffers':[],'types':[]},_0x40d3d2){const _0x343cd1=new collaborativeeditingconnectmessage_1['default'](this['getId'](),_0x5e2120['buffers'],_0x5e2120['types'],this['_bundleVersion'],_0x40d3d2);return this['_connect'](_0x387f25,_0x343cd1);}['reconnect'](_0x166681,_0x528c30){if(this['isConnected']())throw new ckeditorcloudserviceserror_1['default']('Cannot\x20reconnect\x20to\x20already\x20connected\x20service.',_0x166681);return this['_connect'](_0x166681,new collaborativeeditingreconnectmessage_1['default'](this['getId'](),_0x528c30,this['_bundleVersion']));}['disconnect'](){this['_isConnected']&&(this['_isConnected']=!0x1,this['_wsGateway']&&(this['stopListening'](this['_wsGateway']),this['_wsGateway']=void 0x0),this['_channel']&&(this['stopListening'](this['_channel']),this['_channel']=void 0x0),this['_connectedSessions']&&(this['_connectedSessions']['disconnect'](),this['_connectedSessions']=void 0x0),this['fire']('disconnected'),this['stopListening']());}async['getDocumentDetails'](){const _0x4a1917=new getdocumentdetailsmessage_1['default'](this['getId']());if(!this['_wsGateway'])throw new ServiceNotConnectedError_1['default']('Collaborative\x20Editing',this);const _0x54468b=await this['_wsGateway']['_sendRequest'](exports['_SERVICE'],getdocumentdetailsmessage_1['default']['TYPE'],messagescompressor_1['default']['encode'](_0x4a1917));return messagescompressor_1['default']['decode'](_0x54468b,getdocumentdetailsresponse_1['default']);}async['sendOperations'](_0x1c9c15,_0x2d50f6,_0x4c6603){if(!_0x1c9c15||!_0x1c9c15['types']||!_0x1c9c15['types']['length'])throw new ckeditorcloudserviceserror_1['default']('Cannot\x20send\x20empty\x20update.',this['_wsGateway']);const _0x31c1d1='number'==typeof _0x2d50f6?_0x2d50f6:parseInt(_0x2d50f6);if(!Number['isInteger'](_0x31c1d1)||_0x31c1d1<0x0)throw new ckeditorcloudserviceserror_1['default']('Base\x20version\x20not\x20provided.',this['_wsGateway']);const _0x570fee=new collaborativeeditingupdatemessage_1['default'](this['getId'](),_0x1c9c15['buffers'],_0x1c9c15['types'],_0x31c1d1,[],_0x4c6603);if(!this['_wsGateway']||!this['_isConnected'])throw new ServiceNotConnectedError_1['default']('Collaborative\x20Editing',this);const _0x38c111=await this['_wsGateway']['_sendRequest'](exports['_SERVICE'],collaborativeeditingupdatemessage_1['default']['TYPE'],messagescompressor_1['default']['encode'](_0x570fee));return messagescompressor_1['default']['decode'](_0x38c111,collaborativeeditingresponse_1['default']);}async['getConnectedSessions'](){if(!this['_isConnected'])throw new ServiceNotConnectedError_1['default']('Collaborative\x20Editing',this);return this['_connectedSessions']||(this['_connectedSessions']=await sessions_1['default']['getConnectedSessions'](this['_wsGateway'],this['_id'],exports['_SERVICE'])),this['_connectedSessions'];}static['getConnectedSessions'](_0x13e742,_0x1e1753){return sessions_1['default']['getConnectedSessions'](_0x13e742,_0x1e1753,exports['_SERVICE']);}async['_connect'](_0x12767c,_0x1ced99){if(this['isConnected']())return;if(_0x12767c['state']!==websocketgateway_1['default']['STATE_CONNECTED'])throw new ckeditorcloudserviceserror_1['default']('WebSocket\x20Gateway\x20is\x20not\x20connected.',_0x12767c);this['_wsGateway']=_0x12767c,this['stopListening'](_0x12767c,'change:state');const _0x57f639=await _0x12767c['_sendRequest'](exports['_SERVICE'],_0x1ced99['constructor']['TYPE'],messagescompressor_1['default']['encode'](_0x1ced99)),_0x108c14=messagescompressor_1['default']['decode'](_0x57f639,collaborativeeditingconnectresponse_1['default']);return this['listenTo'](_0x12767c,'change:state',(_0x17cfc0,_0x251b86,_0x582b93)=>this['_onWsGatewayStateChange'](_0x582b93),{'priority':websocketgateway_1['default']['_CHANGE_STATE_EVENT_PRIORITY']}),this['_connectToChannel'](_0x12767c,_0x108c14['channel']),this['_isConnected']=!0x0,this['fire']('connected'),_0x108c14;}['_connectToChannel'](_0x3e9fad,_0x2eb427){this['_channel']=_0x3e9fad['_getChannel'](exports['_SERVICE'],_0x2eb427),this['listenTo'](this['_channel'],this['_channel']['getEventName'](collaborativeeditingupdatemessage_1['default']['TYPE']),(_0x4f6af3,_0x24ed1c)=>{const _0x370d2a=messagescompressor_1['default']['decode'](_0x24ed1c,collaborativeeditingupdatemessage_1['default']);this['fire']('operationsReceived',_0x370d2a['baseVersion'],_0x370d2a['data'],_0x370d2a['metadata']);});}['_onWsGatewayStateChange'](_0x4721d7){_0x4721d7===websocketgateway_1['default']['STATE_DISCONNECTED']&&this['disconnect']();}}CollaborativeEditingService['_SERVICE']=exports['_SERVICE'],(0x0,utils_1['mix'])(CollaborativeEditingService,utils_1['EmitterMixin']),exports['default']=CollaborativeEditingService;