/*
 *             Copyright (c) 2016 - 2022, CKSource Holding sp. z o.o. All rights reserved.
 *
 *
 *
 *
 *          +---------------------------------------------------------------------------------+
 *          |                                                                                 |
 *          |                                 Hello stranger!                                 |
 *          |                                                                                 |
 *          |                                                                                 |
 *          |   What you're currently looking at is the source code of a legally protected,   |
 *          |    proprietary software. Any attempts to deobfuscate / disassemble this code    |
 *          |               are forbidden and will result in legal consequences.              |
 *          |                                                                                 |
 *          |                                                                                 |
 *          +---------------------------------------------------------------------------------+
 *
 *
 *
 *
 */
'use strict';var __importDefault=this&&this['__importDefault']||function(_0x53ce77){return _0x53ce77&&_0x53ce77['__esModule']?_0x53ce77:{'default':_0x53ce77};};Object['defineProperty'](exports,'__esModule',{'value':!0x0}),exports['WEB_SOCKET_GATEWAY_STATES']=void 0x0;const socket_io_client_1=require('socket.io-client'),url_parse_1=__importDefault(require('url-parse')),utils_1=require('ckeditor5/src/utils'),channel_1=__importDefault(require('./channel')),user_1=__importDefault(require('./../users/user')),version_1=__importDefault(require('./../version')),ckeditorcloudserviceserror_1=__importDefault(require('./../ckeditorcloudserviceserror')),ckeditorcloudservicesservererror_1=__importDefault(require('./../ckeditorcloudservicesservererror')),parser_1=require('./parser/parser'),requestsmanager_1=__importDefault(require('./requestsmanager'));var WEB_SOCKET_GATEWAY_STATES;!function(_0x497197){_0x497197['DISCONNECTED']='disconnected',_0x497197['CONNECTING']='connecting',_0x497197['CONNECTED']='connected';}(WEB_SOCKET_GATEWAY_STATES=exports['WEB_SOCKET_GATEWAY_STATES']||(exports['WEB_SOCKET_GATEWAY_STATES']={}));class WebSocketGateway{constructor(_0x457089,_0x39d6e1,_0x280d27={},_0x274b25=socket_io_client_1['io'],_0x5150ed=user_1['default']['get']){if(this['_token']=_0x39d6e1,this['_options']=_0x280d27,this['_connectionProvider']=_0x274b25,this['_userFactory']=_0x5150ed,this['_requestsManager']=new requestsmanager_1['default'](this),this['_channels']=new Map(),this['_connectionAttempt']=0x0,!_0x457089)throw new TypeError('Api\x20address\x20must\x20be\x20provided.');if(!this['_token'])throw new TypeError('Token\x20must\x20be\x20provided.');this['_options']['requestTimeout']||(this['_options']['requestTimeout']=0x2710),this['_url']=(0x0,url_parse_1['default'])(_0x457089['replace'](/^(?!(?:\w+:)?\/\/)/,'https://')),this['set']('state','disconnected'),this['set']('socketId',void 0x0),this['set']('me',void 0x0),this['on']('change:state',async(_0x236156,_0x39176b,_0x1bc7e1)=>{var _0x4d40d9;if(_0x1bc7e1!==WebSocketGateway['STATE_CONNECTED']){if(_0x1bc7e1===WebSocketGateway['STATE_DISCONNECTED'])return this['_requestsManager']['errorAll'](new ckeditorcloudserviceserror_1['default']('Not\x20connected.',this));}else try{this['me']=await this['_userFactory']['call'](user_1['default'],this,null===(_0x4d40d9=this['_socketAuth'])||void 0x0===_0x4d40d9?void 0x0:_0x4d40d9['userId']);}catch(_0x18c786){}},{'priority':WebSocketGateway['_CHANGE_STATE_EVENT_PRIORITY']}),this['on']('error',(_0x16f209,_0x494268)=>{this['_options']['onError']?this['_options']['onError'](_0x494268):console['error'](_0x494268);});}get['sessionId'](){return this['socketId'];}['disconnect'](){var _0x1ba02f;this['state']!==WEB_SOCKET_GATEWAY_STATES['DISCONNECTED']&&(null===(_0x1ba02f=this['_socket'])||void 0x0===_0x1ba02f||_0x1ba02f['disconnect'](),this['_socket']=void 0x0,this['state']=WEB_SOCKET_GATEWAY_STATES['DISCONNECTED']);}async['reconnect'](){this['_socket']||this['state']!==WEB_SOCKET_GATEWAY_STATES['DISCONNECTED']||(await this['_token']['refreshToken'](),await this['_connect']());}static async['connect'](_0xea4731,_0x5da188='local.cs.dev:443/ws-v2',_0x54eee2={},_0x590869=socket_io_client_1['io'],_0x1c3031=user_1['default']['get']){const _0xc1f8fe=new WebSocketGateway(_0x5da188,_0xea4731,_0x54eee2,_0x590869,_0x1c3031);return await _0xc1f8fe['_connect'](),_0xc1f8fe;}['_sendRequest'](_0x33b6fb,_0x33df60,_0x46591f){if(!_0x33b6fb)throw new ckeditorcloudserviceserror_1['default']('`serviceName`\x20must\x20be\x20provided.',this);if(this['state']!==WebSocketGateway['STATE_CONNECTED'])throw new ckeditorcloudserviceserror_1['default']('Not\x20connected.',this);if(!this['_socketAuth']||!this['_socketAuth']['isAuthenticated'])throw new ckeditorcloudserviceserror_1['default']('Not\x20authenticated.',this);const _0x14d4ad=new ArrayBuffer(_0x46591f['length']+0x2),_0x1e041b=new Uint8Array(_0x14d4ad);return _0x1e041b[0x0]=_0x33b6fb,_0x1e041b[0x1]=parseInt(_0x33df60),_0x1e041b['set'](_0x46591f,0x2),this['_emit'](0x1,_0x1e041b);}['_getChannel'](_0x259512,_0x2bc8a8){const _0xbc8a41=''+_0x259512+_0x2bc8a8;return!this['_channels']['has'](_0xbc8a41)&&this['_socket']&&this['_channels']['set'](_0xbc8a41,new channel_1['default'](_0xbc8a41,this,this['_socket'])),this['_channels']['get'](_0xbc8a41);}['_connect'](){return new Promise((_0x42b8ba,_0x291be1)=>{const _0x4f6313=this['_setupSocket']();!this['socketId']&&_0x4f6313['io']['on']('reconnect_error',()=>{this['_reconnectionAttemptError'](_0x291be1);}),_0x4f6313['once']('connect',async()=>{try{await this['_onConnect'](),_0x42b8ba();}catch(_0x730558){_0x291be1(_0x730558);}}),_0x4f6313['connect']();});}['_getPortByProtocol'](_0x5c13f3){return['http:','ws:']['includes'](_0x5c13f3)?0x50:0x1bb;}['_setupSocket'](){var _0x452e29;if(this['_socket'])return this['_socket'];const _0x1320f4=this['_url']['port']||this['_getPortByProtocol'](this['_url']['protocol']),_0x5c8e9f=(this['_url']['protocol']||'https:')+'//'+this['_url']['hostname']+':'+_0x1320f4,_0x5325fa=this['_connectionProvider'](_0x5c8e9f,{'parser':{'Encoder':parser_1['Encoder'],'Decoder':parser_1['Decoder']},'path':'/ws-v2/ws','transports':['websocket'],'timeout':void 0x0!==this['_options']['timeout']?this['_options']['timeout']:0x1388,'reconnection':void 0x0===this['_options']['autoReconnect']||this['_options']['autoReconnect'],'reconnectionDelay':0x3e8,'reconnectionDelayMax':0x1388,'rejectUnauthorized':void 0x0===this['_options']['rejectUnauthorized']||this['_options']['rejectUnauthorized'],'query':{'version':version_1['default']},'agent':null!==(_0x452e29=this['_options']['agent'])&&void 0x0!==_0x452e29&&_0x452e29});return this['state']=WEB_SOCKET_GATEWAY_STATES['CONNECTING'],_0x5325fa['on']('connect',()=>{this['socketId']=_0x5325fa['id'];}),_0x5325fa['on']('connect_error',this['_onError']['bind'](this)),_0x5325fa['on']('disconnect',this['_onDisconnect']['bind'](this)),_0x5325fa['io']['on']('reconnect',this['_onReconnect']['bind'](this)),_0x5325fa['io']['on']('reconnect_attempt',_0xa758cd=>{this['state']=WEB_SOCKET_GATEWAY_STATES['CONNECTING'],this['_connectionAttempt']=_0xa758cd;}),_0x5325fa['on']('unauthorized',this['_onUnauthorized']['bind'](this)),this['_socket']=_0x5325fa,_0x5325fa;}['_emit'](_0x3b7271,_0x1c5ce1){const _0x524fe1=this['_socket'];return this['_requestsManager']['send'](_0x5461cb=>{_0x524fe1['emit'](_0x3b7271,_0x1c5ce1,(_0xc329ca,_0x4d299b)=>{if(_0xc329ca)return _0x5461cb['error'](ckeditorcloudservicesservererror_1['default']['fromPublicError'](_0xc329ca));_0x5461cb['response'](_0x4d299b);});},this['_options']['requestTimeout']);}['_addAuthData'](_0x312a25,_0x563c17){this['_socketAuth']={'environmentId':_0x312a25,'userId':_0x563c17,'isAuthenticated':!0x0};}['_removeAuthData'](){this['_socketAuth']=void 0x0;}async['_onConnect'](){await this['_authenticate'](this['_token']['value']),this['state']=WEB_SOCKET_GATEWAY_STATES['CONNECTED'];const _0x1ab8aa=async(_0x57204a,_0x4b0064,_0x1badda)=>{try{await this['_authenticate'](_0x1badda);}catch(_0xe71dd4){}};this['_token']['on']('change:value',_0x1ab8aa),this['_socket']['io']['off']('reconnect_error'),this['on']('disconnect',()=>{this['_token']['off']('change:value',_0x1ab8aa);});}async['_onReconnect'](){await this['_token']['refreshToken'](),await this['_onConnect']();}['_onDisconnect'](){this['state']=WEB_SOCKET_GATEWAY_STATES['DISCONNECTED'],this['_connectionAttempt']=0x0,this['fire']('disconnect');for(const _0x2acab0 of this['_channels']['values']())_0x2acab0['remove']();this['_channels']['clear'](),void 0x0===this['_options']['autoReconnect']||this['_options']['autoReconnect']||(this['_socket']=void 0x0);}['_onError'](_0x340b30){console['warn']('Connection\x20to\x20WebSocket\x20server\x20failed.\x20Details:\x20',{'originalError':_0x340b30});}['_reconnectionAttemptError'](_0x1fd831){this['_connectionAttempt']>=0x2&&(this['disconnect'](),_0x1fd831(new ckeditorcloudserviceserror_1['default']('The\x20number\x20of\x20initial\x20connection\x20attempts\x20exceeded.')));}['_onUnauthorized']({error:error}){this['_removeAuthData'](),this['fire']('error',ckeditorcloudservicesservererror_1['default']['fromPublicError'](error));}async['_authenticate'](_0x162b1c){try{const _0x16eb31=await this['_emit'](0x2,{'token':_0x162b1c});this['_addAuthData'](_0x16eb31['environmentId'],_0x16eb31['userId']);}catch(_0x3460db){throw this['_removeAuthData'](),_0x3460db;}}}WebSocketGateway['STATE_DISCONNECTED']=WEB_SOCKET_GATEWAY_STATES['DISCONNECTED'],WebSocketGateway['STATE_CONNECTING']=WEB_SOCKET_GATEWAY_STATES['CONNECTING'],WebSocketGateway['STATE_CONNECTED']=WEB_SOCKET_GATEWAY_STATES['CONNECTED'],WebSocketGateway['_CHANGE_STATE_EVENT_PRIORITY']=utils_1['priorities']['get']('highest')+0xf423f,(0x0,utils_1['mix'])(WebSocketGateway,utils_1['ObservableMixin']),exports['default']=WebSocketGateway;